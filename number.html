<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Â§ö‰ΩçÊï∞Â≠¶‰π†Á≥ªÁªü</title>
    <style>
      :root {
        --main-color: #2563eb;
        --success-color: #4caf50;
        --danger-color: #f44336;
        --warning-color: #ffd700;
      }

      * {
        touch-action: manipulation;
      }

      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 15px 0;
        background-color: #f0f9ff;
        font-family: "Arial Rounded", Arial, sans-serif;
        box-sizing: border-box;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }

      .title {
        font-size: 1.5rem;
        color: var(--main-color);
        margin-bottom: 15px;
        text-align: center;
        padding: 0 10px;
      }

      .digits-container {
        display: flex;
        gap: 1px;
        margin: 15px 0;
        width: 100%;
        padding: 0;
        box-sizing: border-box;
        justify-content: space-between;
        position: relative;
      }

      .digit-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 0;
        transition: transform 0.2s;
        padding: 0 1px;
      }

      .digit-group:hover {
        transform: scale(1.05);
      }

      .number {
        font-size: 2.8rem;
        color: var(--main-color);
        margin: 2px 0;
        text-align: center;
        min-width: 35px;
        transition: all 0.3s;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .number.changed {
        animation: numberChange 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }

      @keyframes numberChange {
        0% {
          transform: scale(1);
        }
        40% {
          transform: scale(1.4);
        }
        60% {
          transform: scale(0.9);
        }
        100% {
          transform: scale(1);
        }
      }

      .button {
        padding: 8px 6px;
        font-size: 1.2rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin: 1px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
        transition: all 0.2s;
        white-space: nowrap;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .digit-button {
        width: 100%;
        max-width: 45px;
      }

      .action-button {
        width: 100%;
        max-width: 120px;
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .button:active {
        transform: translateY(0);
      }

      .increment {
        background-color: var(--success-color);
        color: white;
      }
      .decrement {
        background-color: var(--danger-color);
        color: white;
      }
      .reset {
        background-color: var(--main-color);
        color: white;
      }
      .random {
        background-color: var(--main-color);
        color: white;
      }

      .button-container {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        justify-content: center;
        width: 100%;
        max-width: 300px;
        padding: 0 10px;
      }

      .digit-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 2px;
      }

      .total-number {
        display: inline-flex;
        align-items: stretch;
        font-size: 1.4rem;
        color: var(--main-color);
        margin: 15px 0;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: 45px;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .total-label {
        background-color: var(--main-color);
        color: white;
        padding: 0 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .total-value {
        background-color: white;
        padding: 0 15px;
        min-width: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .level-select {
        font-size: 1rem;
        color: #333;
        margin-bottom: 10px;
        text-align: center;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .level-select.hidden {
        opacity: 0;
        visibility: hidden;
        height: 0;
        margin: 0;
      }

      .level-select select {
        font-size: 1rem;
        padding: 2px 8px;
        border-radius: 5px;
        border: 1px solid #2563eb;
        margin-left: 6px;
      }

      @media (min-width: 480px) {
        body {
          padding: 15px 0;
        }
        .digits-container {
          gap: 2px;
          padding: 0 5px;
        }
        .digit-group {
          padding: 0 3px;
        }
        .button-container {
          max-width: 400px;
          gap: 15px;
        }
        .number {
          font-size: 3.5rem;
        }
        .button {
          font-size: 1.4rem;
          padding: 10px 8px;
        }
        .digit-button {
          max-width: 55px;
        }
        .digit-label {
          font-size: 1rem;
        }
      }

      @media (min-width: 768px) {
        body {
          padding: 20px 0;
        }
        .digits-container {
          gap: 3px;
          padding: 0 10px;
        }
        .digit-group {
          padding: 0 5px;
        }
        .button-container {
          max-width: 500px;
          gap: 20px;
        }
        .number {
          font-size: 4.5rem;
        }
        .button {
          font-size: 1.6rem;
          padding: 12px 10px;
        }
        .digit-button {
          max-width: 65px;
        }
        .digit-label {
          font-size: 1.1rem;
        }
      }

      .mascot {
        font-size: 3.2rem;
        text-align: center;
        margin-bottom: 8px;
        transition: transform 0.3s;
        user-select: none;
        pointer-events: none;
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 100;
        font-size: 8rem;
        text-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      }

      .mascot.happy {
        transform: translate(-50%, -50%) scale(1.2) rotate(-10deg);
      }

      .mascot.surprise {
        transform: translate(-50%, -50%) scale(1.3) rotate(10deg);
      }

      .mascot.encourage {
        animation: mascotEncourage 0.6s;
        display: block;
      }

      @keyframes mascotEncourage {
        0% {
          transform: translate(-50%, -50%) scale(1);
        }
        30% {
          transform: translate(-50%, -50%) scale(1.4) rotate(-8deg);
        }
        60% {
          transform: translate(-50%, -50%) scale(1.2) rotate(8deg);
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
        }
      }

      .number.changed {
        animation: numberChange 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }
      @keyframes numberChange {
        0% {
          transform: scale(1);
        }
        40% {
          transform: scale(1.4);
        }
        60% {
          transform: scale(0.9);
        }
        100% {
          transform: scale(1);
        }
      }

      .game-task {
        display: inline-flex;
        align-items: stretch;
        font-size: 1.2rem;
        color: var(--main-color);
        margin-bottom: 8px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: 45px;
        font-weight: bold;
        background: none;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .game-task.hidden {
        opacity: 0;
        visibility: hidden;
        height: 0;
        margin: 0;
      }

      .game-task-label {
        background-color: var(--main-color);
        color: white;
        padding: 0 16px;
        display: flex;
        align-items: center;
      }

      .game-task-value {
        background-color: #fff;
        color: var(--main-color);
        padding: 0 20px;
        min-width: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3em;
      }

      .game-task-value span {
        display: inline-block;
      }

      .game-task-value.animated span {
        animation: taskNumberPop 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }

      @keyframes taskNumberPop {
        0% {
          transform: scale(1) rotate(0deg);
        }
        20% {
          transform: scale(1.3) rotate(-10deg);
        }
        40% {
          transform: scale(1.3) rotate(10deg);
        }
        60% {
          transform: scale(1.3) rotate(-5deg);
        }
        80% {
          transform: scale(1.3) rotate(5deg);
        }
        100% {
          transform: scale(1) rotate(0deg);
        }
      }

      .game-achievement {
        font-size: 2rem;
        color: #f59e42;
        margin-bottom: 8px;
        text-align: center;
        min-height: 2.5em;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .game-achievement.hidden {
        opacity: 0;
        visibility: hidden;
        height: 0;
        margin: 0;
      }

      .sticker-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        min-height: 1em; /* Âõ∫ÂÆöÊòüÊòüÂå∫ÂüüÈ´òÂ∫¶ÔºåÈò≤Ê≠¢ÂÜÖÂÆπÂ¢ûÂ§öÊó∂Êå§Âä®‰∏ãÊñπÊ®°Âùó */
        margin-top: 2px;
      }

      .sticker {
        font-size: 1.5rem;
        margin: 0 2px;
        vertical-align: middle;
        transition: transform 0.3s;
      }
      .sticker.earned {
        animation: stickerPop 0.6s;
      }
      @keyframes stickerPop {
        0% {
          transform: scale(0.2);
        }
        60% {
          transform: scale(1.5);
        }
        100% {
          transform: scale(1);
        }
      }

      .game-switch {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
        font-size: 1rem;
        color: #666;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--main-color);
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      /* Ê∑ªÂä†ÈÅÆÁΩ©Â±Ç */
      .mascot-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        z-index: 99;
        display: none;
        transition: scale 0.3s;
        transform: scale(1.05);
      }

      .mascot-overlay.active {
        display: block;
      }

      .mascot-overlay .mascot {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>
  </head>
  <body>
    <h1 class="title">‰∏ÄËµ∑Êù•Áé©Êï∞Â≠óÊ∏∏ÊàèÂêßÔºÅ</h1>
    <div class="game-switch">
      <span>Ê∏∏ÊàèÊ®°ÂºèÔºö</span>
      <label class="switch">
        <input type="checkbox" id="gameModeSwitch" />
        <span class="slider"></span>
      </label>
    </div>
    <div class="level-select">
      ÈÄâÊã©ÁªÉ‰π†ÈöæÂ∫¶Ôºö
      <select id="levelSelect">
        <option value="units">‰∏™‰Ωç</option>
        <option value="tens">ÂçÅ‰Ωç</option>
        <option value="hundreds">Áôæ‰Ωç</option>
        <option value="thousands">ÂçÉ‰Ωç</option>
        <option value="tenThousands">‰∏á‰Ωç</option>
      </select>
    </div>
    <div class="game-task" id="gameTask">
      <span class="game-task-label">‰ªªÂä°ÔºöËØ∑ÊääÊï∞Â≠óË∞ÉÂà∞</span>
      <span class="game-task-value" id="targetNumber"><span>0</span></span>
    </div>
    <div class="game-achievement">
      Â∑≤Ëé∑ÂæóË¥¥Á∫∏Ôºö<span id="stickerCount">0</span>
      <div class="sticker-row" id="stickerArea"></div>
    </div>
    <div class="total-number">
      <span class="total-label">ÂΩìÂâçÊï∞Â≠ó</span>
      <span class="total-value" id="totalNumber">0</span>
    </div>

    <div class="digits-container">
      <div class="mascot-overlay">
        <div id="mascot" class="mascot">üòä</div>
      </div>
      <!-- ‰∏á‰Ωç -->
      <div class="digit-group">
        <div class="digit-label">‰∏á‰Ωç</div>
        <button
          class="button increment digit-button"
          onclick="changeDigit(4, 1)"
        >
          +
        </button>
        <div class="number" id="tenThousandsDigit">0</div>
        <button
          class="button decrement digit-button"
          onclick="changeDigit(4, -1)"
        >
          -
        </button>
      </div>

      <!-- ÂçÉ‰Ωç -->
      <div class="digit-group">
        <div class="digit-label">ÂçÉ‰Ωç</div>
        <button
          class="button increment digit-button"
          onclick="changeDigit(3, 1)"
        >
          +
        </button>
        <div class="number" id="thousandsDigit">0</div>
        <button
          class="button decrement digit-button"
          onclick="changeDigit(3, -1)"
        >
          -
        </button>
      </div>

      <!-- Áôæ‰Ωç -->
      <div class="digit-group">
        <div class="digit-label">Áôæ‰Ωç</div>
        <button
          class="button increment digit-button"
          onclick="changeDigit(2, 1)"
        >
          +
        </button>
        <div class="number" id="hundredsDigit">0</div>
        <button
          class="button decrement digit-button"
          onclick="changeDigit(2, -1)"
        >
          -
        </button>
      </div>

      <!-- ÂçÅ‰Ωç -->
      <div class="digit-group">
        <div class="digit-label">ÂçÅ‰Ωç</div>
        <button
          class="button increment digit-button"
          onclick="changeDigit(1, 1)"
        >
          +
        </button>
        <div class="number" id="tensDigit">0</div>
        <button
          class="button decrement digit-button"
          onclick="changeDigit(1, -1)"
        >
          -
        </button>
      </div>

      <!-- ‰∏™‰Ωç -->
      <div class="digit-group">
        <div class="digit-label">‰∏™‰Ωç</div>
        <button
          class="button increment digit-button"
          onclick="changeDigit(0, 1)"
        >
          +
        </button>
        <div class="number" id="unitsDigit">0</div>
        <button
          class="button decrement digit-button"
          onclick="changeDigit(0, -1)"
        >
          -
        </button>
      </div>
    </div>

    <div class="button-container">
      <button class="button reset action-button" onclick="resetAll()">
        ÈáçÁΩÆÂΩíÈõ∂
      </button>
      <button class="button random action-button" onclick="randomNumber()">
        ÈöèÊú∫Êï∞Â≠ó
      </button>
    </div>
    <script>
      let digits = [0, 0, 0, 0, 0];
      let speechSynthesis = window.speechSynthesis;
      let speaking = false;
      let speakTimeout = null;
      let firstLoad = true;
      let targetNumber = 0;
      let stickerCount = 0;
      let isPlayingSuccess = false;
      let isGameMode = false; // ÈªòËÆ§ÂÖ≥Èó≠Ê∏∏ÊàèÊ®°Âºè

      // Èü≥ÊïàËµÑÊ∫êÔºàÂèØÊõøÊç¢‰∏∫Êú¨Âú∞Êñá‰ª∂Ôºâ
      const soundMap = {
        click: "https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b2.mp3",
        reset: "https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b7bfa.mp3",
        success:
          "https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b7bfa.mp3",
      };
      function playSound(type) {
        const audio = new Audio(soundMap[type] || soundMap.click);
        audio.volume = 0.5;
        audio.play();
      }

      // Ë°®ÊÉÖÂèòÂåñ
      function setMascot(type) {
        const mascot = document.getElementById("mascot");
        mascot.className = "mascot"; // Ê∏ÖÈô§ÊâÄÊúâË°®ÊÉÖÂíåÂä®Áîª
        if (type === "encourage") {
          mascot.textContent = "üëè";
          mascot.classList.add("encourage");
          mascot.style.display = "block";
        } else {
          mascot.style.display = "none";
        }
      }

      function speakWelcome() {
        if (speaking) {
          speechSynthesis.cancel();
        }
        const utterance = new SpeechSynthesisUtterance("‰∏ÄËµ∑Êù•Áé©Êï∞Â≠óÊ∏∏ÊàèÂêß");
        utterance.lang = "zh-CN";
        utterance.rate = 0.9;
        utterance.pitch = 1;
        speaking = true;
        utterance.onend = () => {
          speaking = false;
        };
        speechSynthesis.speak(utterance);
      }

      // Â∞ÜÊï∞Â≠óËΩ¨Êç¢‰∏∫‰∏≠ÊñáËØªÊ≥ï
      function numberToChinese(num) {
        const units = ["", "ÂçÅ", "Áôæ", "ÂçÉ", "‰∏á"];
        const digits = [
          "Èõ∂",
          "‰∏Ä",
          "‰∫å",
          "‰∏â",
          "Âõõ",
          "‰∫î",
          "ÂÖ≠",
          "‰∏É",
          "ÂÖ´",
          "‰πù",
        ];

        if (num === 0) return "Èõ∂";

        let result = "";
        let unitIndex = 0;

        while (num > 0) {
          const digit = num % 10;
          if (digit !== 0) {
            result = digits[digit] + units[unitIndex] + result;
          } else if (result && result[0] !== "Èõ∂") {
            result = "Èõ∂" + result;
          }
          num = Math.floor(num / 10);
          unitIndex++;
        }

        // Â§ÑÁêÜÁâπÊÆäÊÉÖÂÜµ
        result = result.replace(/Èõ∂+$/, "");
        result = result.replace(/^‰∏ÄÂçÅ/, "ÂçÅ");

        return result;
      }

      function speakNumber(num) {
        // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
        if (speakTimeout) {
          clearTimeout(speakTimeout);
        }

        // ÂÅúÊ≠¢ÂΩìÂâçÊ≠£Âú®Êí≠ÊîæÁöÑËØ≠Èü≥
        if (speaking) {
          speechSynthesis.cancel();
        }

        // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®ÔºåÂª∂Ëøü300msÂêéÊí≠Êîæ
        speakTimeout = setTimeout(() => {
          const text = numberToChinese(num);
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "zh-CN";
          utterance.rate = 0.8;
          utterance.pitch = 1;

          speaking = true;
          utterance.onend = () => {
            speaking = false;
          };

          speechSynthesis.speak(utterance);
        }, 300);
      }

      function changeDigit(position, delta) {
        digits[position] += delta;

        // Ëøõ‰Ωç/ÂÄü‰ΩçÂ§ÑÁêÜ
        for (let i = position; i < digits.length; i++) {
          while (digits[i] > 9) {
            if (i < digits.length - 1) {
              digits[i + 1]++;
              digits[i] -= 10;
            } else {
              digits[i] = 9;
            }
          }
          while (digits[i] < 0) {
            if (i < digits.length - 1) {
              digits[i + 1]--;
              digits[i] += 10;
            } else {
              digits[i] = 0;
            }
          }
        }

        updateDisplay();
        playSound("click");
      }

      // ÂàÜÁ∫ßÈöæÂ∫¶Êò†Â∞Ñ
      const levelMap = {
        units: 9,
        tens: 99,
        hundreds: 999,
        thousands: 9999,
        tenThousands: 99999,
      };
      let currentLevel = "units";

      // ÁõëÂê¨ÈöæÂ∫¶ÈÄâÊã©
      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("levelSelect")
          .addEventListener("change", function () {
            currentLevel = this.value;
            newGameTask();
          });
      });

      // ÁõëÂê¨Ê∏∏ÊàèÊ®°ÂºèÂºÄÂÖ≥
      document.addEventListener("DOMContentLoaded", function () {
        const gameModeSwitch = document.getElementById("gameModeSwitch");
        const gameTask = document.getElementById("gameTask");
        const gameAchievement = document.querySelector(".game-achievement");
        const levelSelect = document.querySelector(".level-select");

        gameModeSwitch.addEventListener("change", function () {
          isGameMode = this.checked;
          if (isGameMode) {
            newGameTask();
            gameTask.classList.remove("hidden");
            gameAchievement.classList.remove("hidden");
            levelSelect.classList.remove("hidden");
          } else {
            // ÂÖ≥Èó≠Ê∏∏ÊàèÊ®°ÂºèÊó∂ÔºåÊ∏ÖÈô§ÂΩìÂâç‰ªªÂä°
            targetNumber = 0;
            document
              .getElementById("targetNumber")
              .querySelector("span").textContent = "";
            gameTask.classList.add("hidden");
            gameAchievement.classList.add("hidden");
            levelSelect.classList.add("hidden");
          }
        });
      });

      // ÈºìÂä±ËØ≠Èü≥Â∫èÂàó
      function playSuccessSequence(currentNumber, nextNumber) {
        if (speaking) speechSynthesis.cancel();

        isPlayingSuccess = true;

        // ÂàõÂª∫ËØ≠Èü≥ÈòüÂàó
        const sequence = [
          {
            text: numberToChinese(currentNumber),
            rate: 0.8,
            pitch: 1,
          },
          {
            text: "Â§™Ê£í‰∫ÜÔºÅ‰Ω†ÂÆåÊàê‰∫Ü‰ªªÂä°ÔºÅËØ∑ÂÆåÊàê‰∏ã‰∏Ä‰∏™‰ªªÂä°",
            rate: 1,
            pitch: 1.1,
          },
          {
            text: numberToChinese(nextNumber),
            rate: 0.8,
            pitch: 1,
          },
        ];

        let index = 0;

        function playNext() {
          if (index >= sequence.length) {
            speaking = false;
            isPlayingSuccess = false;
            return;
          }

          const item = sequence[index];
          const utterance = new SpeechSynthesisUtterance(item.text);
          utterance.lang = "zh-CN";
          utterance.rate = item.rate;
          utterance.pitch = item.pitch;

          utterance.onend = () => {
            index++;
            playNext();
          };

          speechSynthesis.speak(utterance);
        }

        speaking = true;
        playNext();
      }

      // Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàê‰ªªÂä°
      function checkGameTask(current) {
        if (current === targetNumber) {
          stickerCount++;
          updateStickers();
          setMascot("encourage");

          // ÁîüÊàêÊñ∞‰ªªÂä°
          const max = levelMap[currentLevel];
          const nextNumber = Math.floor(Math.random() * (max + 1));

          // Êí≠ÊîæËØ≠Èü≥Â∫èÂàó
          playSuccessSequence(current, nextNumber);

          // Êõ¥Êñ∞ÊòæÁ§∫
          setTimeout(() => {
            targetNumber = nextNumber;
            const taskElem = document.getElementById("targetNumber");
            taskElem.querySelector("span").textContent = targetNumber;
            taskElem.classList.add("animated");
            setTimeout(() => taskElem.classList.remove("animated"), 800);
            setMascot("encourage");
          }, 1200);
        }
      }

      // ÁîüÊàêÊñ∞‰ªªÂä°Ôºà‰øÆÊ≠£ÂêéÔºâ
      function newGameTask() {
        const max = levelMap[currentLevel];
        targetNumber = Math.floor(Math.random() * (max + 1));
        const taskElem = document.getElementById("targetNumber");
        taskElem.querySelector("span").textContent = targetNumber;
        // Ê∑ªÂä†Âä®ÁîªÁ±ª
        taskElem.classList.add("animated");
        // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§Á±ª
        setTimeout(() => taskElem.classList.remove("animated"), 800);
      }

      function updateDisplay() {
        const elements = {
          unitsDigit: 0,
          tensDigit: 1,
          hundredsDigit: 2,
          thousandsDigit: 3,
          tenThousandsDigit: 4,
        };
        for (const [id, index] of Object.entries(elements)) {
          const element = document.getElementById(id);
          const oldValue = parseInt(element.textContent);
          const newValue = digits[index];
          if (oldValue !== newValue) {
            element.textContent = newValue;
            element.classList.add("changed");
            setTimeout(() => element.classList.remove("changed"), 500);
          }
        }
        // Êõ¥Êñ∞ÊÄªÊï∞
        const total = digits.reduce(
          (acc, val, idx) => acc + val * Math.pow(10, idx),
          0
        );
        document.getElementById("totalNumber").textContent = total;

        // È¶ñÊ¨°Âä†ËΩΩÊó∂‰∏çÊúóËØªÊï∞Â≠ó
        if (firstLoad) {
          firstLoad = false;
          return;
        }

        // Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàê‰ªªÂä°
        if (isGameMode && total === targetNumber) {
          handleTaskComplete(total);
        } else if (!isPlayingSuccess) {
          // Âè™ÊúâÂú®ÈùûÂÆåÊàê‰ªªÂä°Áä∂ÊÄÅ‰∏ãÊâçÊúóËØªÊï∞Â≠ó
          speakNumber(total);
        }
      }

      // Â§ÑÁêÜ‰ªªÂä°ÂÆåÊàê
      function handleTaskComplete(currentNumber) {
        stickerCount++;
        updateStickers();

        // ÊòæÁ§∫ÈÅÆÁΩ©Â±ÇÂíåË°®ÊÉÖ
        const overlay = document.querySelector(".mascot-overlay");
        overlay.classList.add("active");
        setMascot("encourage");

        // ÁîüÊàêÊñ∞‰ªªÂä°
        const max = levelMap[currentLevel];
        const nextNumber = Math.floor(Math.random() * (max + 1));

        // Êí≠ÊîæËØ≠Èü≥Â∫èÂàó
        playSuccessSequence(currentNumber, nextNumber);

        // Êõ¥Êñ∞‰ªªÂä°Êï∞Â≠ó
        setTimeout(() => {
          targetNumber = nextNumber;
          const taskElem = document.getElementById("targetNumber");
          taskElem.querySelector("span").textContent = targetNumber;
          taskElem.classList.add("animated");
          setTimeout(() => taskElem.classList.remove("animated"), 800);
        }, 7000); // Á≠âÂæÖËØ≠Èü≥Êí≠Êä•Âà∞‰∏ã‰∏Ä‰∏™Êï∞Â≠óÊó∂

        // ËØ≠Èü≥Êí≠ÊîæÂÆåÊàêÂêéÈöêËóèÈÅÆÁΩ©ÂíåË°®ÊÉÖ
        setTimeout(() => {
          overlay.classList.remove("active");
        }, 8000); // Á≠âÂæÖËØ≠Èü≥Êí≠ÊîæÂÆåÊàê
      }

      function resetAll() {
        digits = [0, 0, 0, 0, 0];
        updateDisplay();
        playSound("reset");
      }

      function randomNumber() {
        const max = 99999;
        const randomNum = Math.floor(Math.random() * max);
        const numStr = randomNum.toString().padStart(5, "0");
        digits = numStr.split("").map(Number).reverse();
        updateDisplay();
        playSound("success");
      }

      // Êõ¥Êñ∞Ë¥¥Á∫∏ÊòæÁ§∫
      function updateStickers() {
        document.getElementById("stickerCount").textContent = stickerCount;
        const stickerArea = document.getElementById("stickerArea");
        const sticker = document.createElement("span");
        sticker.className = "sticker earned";
        sticker.textContent = "üåü";
        stickerArea.appendChild(sticker);
        // Âè™‰øùÁïôÊúÄËøë10‰∏™Ë¥¥Á∫∏
        while (stickerArea.children.length > 10) {
          stickerArea.removeChild(stickerArea.firstChild);
        }
      }

      // È°µÈù¢ÂàùÂßãÂåñ
      window.addEventListener("DOMContentLoaded", () => {
        updateDisplay();
        speakWelcome();

        // ÂàùÂßãÂåñÊ∏∏ÊàèÊ®°ÂºèÂÖÉÁ¥†Áä∂ÊÄÅ
        const gameTask = document.getElementById("gameTask");
        const gameAchievement = document.querySelector(".game-achievement");
        const levelSelect = document.querySelector(".level-select");

        // ÈªòËÆ§ÈöêËóèÊ∏∏ÊàèÁõ∏ÂÖ≥ÂÖÉÁ¥†
        gameTask.classList.add("hidden");
        gameAchievement.classList.add("hidden");
        levelSelect.classList.add("hidden");
      });
    </script>
  </body>
</html>
